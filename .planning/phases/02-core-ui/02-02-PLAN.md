---
phase: 02-core-ui
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - src/main.ts
autonomous: true

must_haves:
  truths:
    - "User can add a dish with name, quantity, and price"
    - "User can edit existing dish name, quantity, or price"
    - "User can delete a dish"
    - "Line total displays as qty x price"
    - "Tab flow creates new row after price field"
    - "User can enter tax, tip, and total amounts"
    - "Mismatch between calculated and entered total shows warning"
  artifacts:
    - path: "src/main.ts"
      provides: "Dish entry UI and bill totals section"
      contains: "quantity"
  key_links:
    - from: "Dish entry"
      to: "state.dishes"
      via: "event handlers update state and re-render"
      pattern: "state\\.dishes"
    - from: "Bill totals"
      to: "validation display"
      via: "calculated vs entered total comparison"
      pattern: "Off by"
---

<objective>
Build dish entry UI and bill totals section with validation.

Purpose: Enable users to enter the items on their bill with quantity/price, plus tax/tip/total for validation. This is the core data entry before assignment.

Output: Working dish entry with add/edit/delete, continuous tab flow, tax/tip/total inputs, and "Off by $X.XX" warning when totals mismatch.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-ui/02-CONTEXT.md
@.planning/phases/02-core-ui/02-01-SUMMARY.md
@src/main.ts
@src/lib/calculate.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build dish entry UI with quantity and price</name>
  <files>src/main.ts</files>
  <action>
In the render() function, add the Dishes section after Diners:

1. **Section header**: "Dishes" as h2 or styled div

2. **Dish list** - for each dish in state.dishes, render a card/row with:
   - Description input (text, ~200px, placeholder "Item name")
   - Quantity input (number, ~60px, min=1, default=1)
   - Price input (number, ~80px, step=0.01, placeholder "0.00" - this is unit price in dollars for UX, convert to cents internally)
   - Calculated line total display: qty x unitPrice (show as "$X.XX", read-only)
   - Delete button (X or trash)

3. **Event handlers**:
   - Description input `onchange`: update state.dishes[index].name, re-render
   - Quantity input `onchange`: parse as int, update state.dishes[index].quantity, re-render
   - Price input `onchange`: parse as float, multiply by 100, round, store as state.dishes[index].unitPriceCents, re-render
   - Delete button: remove dish from state.dishes, re-render

4. **Tab flow for continuous entry** (per CONTEXT.md):
   - On the price input, listen for `keydown` with key === "Tab" and !shiftKey
   - If this is the last dish row AND the current dish has a name, auto-add a new dish and focus its name input
   - Use setTimeout after re-render to focus the new input

5. **Add button**: "+ Add Dish" button
   - On click: push new Dish with generated id (use crypto.randomUUID()), empty name, quantity=1, unitPriceCents=0, empty assignedTo
   - Focus the new name input after render

6. **Line total calculation**:
   - Create helper `getDishTotalCents(dish: Dish): number` returning dish.quantity * dish.unitPriceCents
   - Display as formatCents(getDishTotalCents(dish)) next to each row

7. **Utility function** (if not exists):
   - `formatCents(cents: number): string` - returns "$X.XX" format (cents / 100, toFixed(2))

Styling (Claude discretion):
- Dish cards with subtle border/shadow, padding
- Inputs inline with gap
- Line total right-aligned or at end of row
- Mobile: stack inputs vertically (media query or flex-wrap)
  </action>
  <verify>
`bun build ./src/index.html --outdir=dist` succeeds.
Manual test:
1. Click "+ Add Dish" - new row appears with empty inputs
2. Enter "Burger", qty 2, price 12.50 - line total shows "$25.00"
3. Tab from price field - creates new row (if dish has name), focuses name input
4. Edit existing dish - values update
5. Delete dish - row removed
  </verify>
  <done>
Dish entry UI renders with name/quantity/price inputs, calculated line total, delete button, add button, and tab-through flow for continuous entry.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build bill totals section with validation</name>
  <files>src/main.ts</files>
  <action>
Add the Bill Totals section after Dishes:

1. **Section header**: "Bill Totals" as h2 or styled div

2. **Three input fields** (all currency inputs showing dollars, stored as cents):
   - Tax input: label "Tax", number input (step=0.01), updates state.taxCents
   - Tip input: label "Tip", number input (step=0.01), updates state.tipCents
   - Total input: label "Total (from receipt)", number input (step=0.01), updates state.enteredTotalCents

3. **Calculated subtotal display**:
   - Calculate: `getSubtotalCents()` = sum of getDishTotalCents(dish) for all dishes
   - Calculate: `getCalculatedTotalCents()` = subtotal + taxCents + tipCents
   - Display "Subtotal: $X.XX" and "Calculated Total: $X.XX" (read-only)

4. **Validation warning** (per CONTEXT.md):
   - If state.enteredTotalCents is not null AND differs from calculated total:
     - Show "Off by $X.XX" message (absolute difference, formatted)
     - Highlight the Total input field with warning color (amber/yellow border or background)
   - If match or no entered total: no warning, normal styling

5. **Event handlers**:
   - Tax/Tip inputs `onchange`: parse float, multiply by 100, round, update state, re-render
   - Total input `onchange`: same conversion, update state.enteredTotalCents (allow clearing to null)

Layout (Claude discretion):
- Horizontal row of labeled inputs on desktop
- Stack vertically on mobile
- Warning message below the total input, warning color on input border
  </action>
  <verify>
`bun build ./src/index.html --outdir=dist` succeeds.
Manual test:
1. Add dishes totaling $25.00
2. Enter Tax: 2.00, Tip: 5.00 - Calculated Total shows $32.00
3. Enter Total: 32.00 - no warning
4. Enter Total: 35.00 - shows "Off by $3.00" with warning styling on Total input
5. Clear Total - warning disappears
  </verify>
  <done>
Bill totals section with Tax, Tip, Total inputs. Subtotal and calculated total displayed. Mismatch shows "Off by $X.XX" warning with highlighted field.
  </done>
</task>

</tasks>

<verification>
1. `bun build ./src/index.html --outdir=dist` completes without errors
2. `bunx tsc --noEmit` passes
3. Browser test: dish entry works (add, edit, delete)
4. Browser test: line totals calculate correctly (qty x price)
5. Browser test: tab flow creates new rows
6. Browser test: bill totals section shows tax/tip/total inputs
7. Browser test: validation warning appears on mismatch, disappears on match
</verification>

<success_criteria>
- Dish entry UI with name/qty/price inputs and calculated line total
- Tab flow auto-creates new dish row
- Add and delete dish functionality
- Bill totals section with Tax, Tip, Total inputs
- Calculated subtotal and total displayed
- "Off by $X.XX" warning when entered total mismatches calculated
- Warning styling highlights the Total input field
- All values stored as integer cents internally
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-ui/02-02-SUMMARY.md`
</output>
